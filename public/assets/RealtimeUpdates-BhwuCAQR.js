import{j as e}from"./vendor-ui-s4VaHhe3.js";import{b as k}from"./vendor-react-BLR_YkO_.js";import{C,b as W,c as E,d as R,a as D,e as H}from"./card-8UZPBAHq.js";import{B as U}from"./badge-D2cBkUuv.js";import{B as S,A as O,a as B,b as P}from"./index-9094wa89.js";import{S as y}from"./skeleton-65i7iYhM.js";import{a as x}from"./Dashboard-CjodtFcV.js";import{x as F,aG as J,C as z}from"./vendor-icons-CgtSIdDt.js";import"./vendor-query-Cm3gWw8b.js";import"./vendor-router-B3zuYAIM.js";import"./vendor-charts-CaNT0DhE.js";import"./profileService-CVm8ufKb.js";import"./apiClient-Ddw1nvhZ.js";import"./select-aXx2Wv-A.js";import"./tabs-BM3G3Ofl.js";class G{constructor(){this.socket=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectTimeout=1e3,this.reconnectTimer=null,this.messageHandlers=new Map,this.userId=null}connect(t){return new Promise(n=>{if(this.socket&&this.socket.readyState===WebSocket.OPEN){console.log("WebSocket already connected"),n(!0);return}this.userId=t;const r=window.location.protocol==="https:"?"wss:":"ws:";let a;a=`${r}//${window.location.host}/ws`;try{this.socket=new WebSocket(a),this.socket.onopen=()=>{console.log("WebSocket connected"),this.reconnectAttempts=0,this.reconnectTimeout=1e3,this.send({type:"auth",userId:t}),n(!0)},this.socket.onmessage=h=>{try{const l=JSON.parse(h.data);if(l.type==="ping"){this.send({type:"pong"});return}this.dispatchMessage(l)}catch(l){console.error("Error parsing WebSocket message:",l)}},this.socket.onclose=()=>{console.log("WebSocket disconnected"),this.socket=null,this.attemptReconnect(),n(!1)},this.socket.onerror=h=>{var l;console.error("WebSocket error:",h),(l=this.socket)==null||l.close()}}catch(h){console.error("Failed to connect to WebSocket:",h),this.attemptReconnect(),n(!1)}})}attemptReconnect(){this.reconnectTimer!==null&&window.clearTimeout(this.reconnectTimer),this.reconnectAttempts<this.maxReconnectAttempts&&this.userId?(console.log(`Attempting to reconnect (${this.reconnectAttempts+1}/${this.maxReconnectAttempts})...`),this.reconnectTimer=window.setTimeout(()=>{this.reconnectAttempts++,this.connect(this.userId),this.reconnectTimeout=Math.min(this.reconnectTimeout*2,3e4)},this.reconnectTimeout)):console.log("Max reconnect attempts reached or no user ID")}send(t){return this.socket&&this.socket.readyState===WebSocket.OPEN?(this.socket.send(JSON.stringify(t)),!0):!1}on(t,n){this.messageHandlers.has(t)||this.messageHandlers.set(t,[]),this.messageHandlers.get(t).push(n)}off(t,n){if(this.messageHandlers.has(t)){const r=this.messageHandlers.get(t),a=r.indexOf(n);a!==-1&&r.splice(a,1)}}dispatchMessage(t){const n=t.type;this.messageHandlers.has(n)&&this.messageHandlers.get(n).forEach(r=>{try{r(t)}catch(a){console.error(`Error in WebSocket handler for type ${n}:`,a)}}),this.messageHandlers.has("all")&&this.messageHandlers.get("all").forEach(r=>{try{r(t)}catch(a){console.error('Error in WebSocket "all" handler:',a)}})}disconnect(){this.reconnectTimer!==null&&(window.clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.socket&&(this.socket.close(),this.socket=null),this.userId=null,this.messageHandlers.clear(),console.log("WebSocket disconnected")}isConnected(){return this.socket!==null&&this.socket.readyState===WebSocket.OPEN}}const u=new G,re=({userId:o})=>{const[t,n]=k.useState([]),[r,a]=k.useState(!1),[h,l]=k.useState(null),[m,N]=k.useState(!0),d=k.useRef(null);k.useEffect(()=>{if(!o||!m){a(!1);return}return l(null),(async()=>{try{const f=await u.connect(o);if(a(f),f){const p=c=>{if(m){const i={id:`update-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"job",message:c.message,timestamp:new Date(c.timestamp),read:!1};n(g=>[i,...g].slice(0,10)),o&&x.trackNotificationInteraction(o,"job","received",i.id)}},b=c=>{if(m){const i={id:`update-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"skill",message:c.message,timestamp:new Date(c.timestamp),read:!1};n(g=>[i,...g].slice(0,10)),o&&x.trackNotificationInteraction(o,"skill","received",i.id)}},j=c=>{if(m){const i={id:`update-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"market",message:c.message,timestamp:new Date(c.timestamp),read:!1};n(g=>[i,...g].slice(0,10)),o&&x.trackNotificationInteraction(o,"market","received",i.id)}};u.on("job",p),u.on("skill",b),u.on("market",j);const w=setInterval(()=>{if(m&&t.length===0){const c=M();n(i=>[c,...i].slice(0,10))}},15e3);return d.current=w,()=>{u.off("job",p),u.off("skill",b),u.off("market",j),d.current&&(clearInterval(d.current),d.current=null)}}}catch(f){console.error("Failed to connect to WebSocket:",f),l("Failed to connect to real-time updates service"),a(!1)}})(),()=>{d.current&&(clearInterval(d.current),d.current=null),a(!1)}},[o,m,t.length]);const M=()=>{const s=["job","skill","market"],f=s[Math.floor(Math.random()*s.length)];let p="";switch(f){case"job":const b=["Warehouse Assistant","Retail Clerk","Security Guard","Admin Assistant"];p=`New ${b[Math.floor(Math.random()*b.length)]} position matching your profile`;break;case"skill":const w=["Customer Service","MS Office","Communication","Problem Solving"];p=`${w[Math.floor(Math.random()*w.length)]} demand increased by ${Math.floor(Math.random()*10)+5}%`;break;case"market":const i=["Retail","Hospitality","Security","Administration"];p=`${i[Math.floor(Math.random()*i.length)]} sector showing ${Math.floor(Math.random()*15)+2}% growth`;break}return{id:`update-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:f,message:p,timestamp:new Date,read:!1}},v=()=>{n(t.map(s=>({...s,read:!0}))),o&&x.trackNotificationInteraction(o,"all","mark_read",`batch-${Date.now()}`)},T=()=>{const s=!m;N(s),o&&x.trackNotificationInteraction(o,"settings",s?"enable":"disable")},A=s=>s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),$=s=>{switch(s){case"job":return"default";case"skill":return"secondary";case"market":return"outline";default:return"default"}};return e.jsxs(C,{className:"h-full",children:[e.jsxs(W,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(E,{children:"Real-time Updates"}),e.jsx(R,{children:r?"Live updates based on your profile and market changes":"Connecting to update service..."})]}),e.jsx(S,{variant:"ghost",size:"icon",onClick:T,title:m?"Disable notifications":"Enable notifications",children:m?e.jsx(F,{className:"h-5 w-5"}):e.jsx(J,{className:"h-5 w-5"})})]}),e.jsxs(D,{className:"max-h-[400px] overflow-y-auto",children:[h&&e.jsxs(O,{variant:"destructive",className:"mb-4",children:[e.jsx(z,{className:"h-4 w-4"}),e.jsx(B,{children:"Error"}),e.jsx(P,{children:h})]}),!r&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"h-12 w-full"}),e.jsx(y,{className:"h-12 w-full"}),e.jsx(y,{className:"h-12 w-full"})]}),r&&t.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-32 text-gray-500",children:[e.jsx("p",{children:"No updates yet"}),e.jsx("p",{className:"text-sm",children:"Updates will appear here as they arrive"})]}),r&&t.length>0&&e.jsx("div",{className:"space-y-3",children:t.map(s=>e.jsxs("div",{className:`p-3 border rounded-lg ${s.read?"bg-gray-50":"bg-blue-50 border-blue-200"}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs(U,{variant:$(s.type),children:[s.type==="job"&&"Job Alert",s.type==="skill"&&"Skill Trend",s.type==="market"&&"Market Insight"]}),e.jsx("span",{className:"text-xs text-gray-500",children:A(s.timestamp)})]}),e.jsx("p",{className:"mt-2 text-sm",children:s.message})]},s.id))})]}),r&&t.length>0&&e.jsxs(H,{className:"flex justify-between",children:[e.jsx(S,{variant:"outline",size:"sm",onClick:v,children:"Mark all as read"}),e.jsxs("span",{className:"text-xs text-gray-500",children:[t.filter(s=>!s.read).length," unread"]})]})]})};export{re as default};
